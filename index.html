<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å·¥æ—¶è®¡ç®—å™¨ V3.5 - æ·±è‰²æ¨¡å¼ç‰ˆ</title>
    <style>
        :root { 
            --primary: #007aff; 
            --bg: #f5f5f7; 
            --card: #ffffff; 
            --text: #1d1d1f; 
            --sub-text: #86868b;
            --border: #d2d2d7;
            --input-bg: #f5f5f7;
            --manual-bg: #fffbeb;
            --status-red: #ff3b30; 
            --status-yellow: #ff9500; 
            --status-green: #34c759; 
            --badge-red-bg: #fff2f2;
            --badge-yellow-bg: #fff9f2;
            --badge-green-bg: #f2fff5;
        }

        /* --- æ·±è‰²æ¨¡å¼é€‚é… --- */
        @media (prefers-color-scheme: dark) {
            :root {
                --bg: #000000;
                --card: #1c1c1e;
                --text: #f5f5f7;
                --sub-text: #a1a1a6;
                --border: #38383a;
                --input-bg: #2c2c2e;
                --manual-bg: #2d2b16; /* æ·±é»„è‰²èƒŒæ™¯ */
                --badge-red-bg: rgba(255, 59, 48, 0.15);
                --badge-yellow-bg: rgba(255, 149, 0, 0.15);
                --badge-green-bg: rgba(52, 199, 89, 0.15);
            }
        }

        body { 
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "PingFang SC", "Microsoft YaHei", sans-serif;
            background: var(--bg); 
            color: var(--text); 
            max-width: 900px; 
            margin: 0 auto; 
            padding: 20px; 
            line-height: 1.5; 
            -webkit-font-smoothing: antialiased;
            transition: background 0.3s, color 0.3s;
        }
        
        .dashboard { display: grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap: 16px; margin-bottom: 24px; }
        .card { background: var(--card); padding: 22px; border-radius: 14px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); text-align: center; border: 1px solid var(--border); }
        .card h3 { margin: 0 0 12px 0; font-size: 13px; color: var(--sub-text); font-weight: 600; }
        
        .dash-input-editable { font-size: 34px; font-weight: 700; color: var(--text); border: none; border-bottom: 2px dashed var(--border); width: 100px; text-align: center; outline: none; background: var(--manual-bg); border-radius: 4px; }
        .dash-value-readonly { font-size: 34px; font-weight: 700; color: var(--primary); font-variant-numeric: tabular-nums; }
        
        .sub-value { font-size: 12px; color: var(--sub-text); margin-top: 8px; }
        .status-badge { font-size: 13px; font-weight: 700; padding: 2px 10px; border-radius: 20px; margin-left: 6px; }
        .st-red { color: var(--status-red); background: var(--badge-red-bg); }
        .st-yellow { color: var(--status-yellow); background: var(--badge-yellow-bg); }
        .st-green { color: var(--status-green); background: var(--badge-green-bg); }

        .input-panel { background: var(--card); padding: 24px; border-radius: 14px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); margin-bottom: 24px; border: 1px solid var(--border); }
        .form-row { display: flex; align-items: center; padding: 14px 0; border-bottom: 1px solid var(--border); }
        .form-row:last-of-type { border-bottom: none; }
        
        .row-label { width: 120px; font-size: 14px; font-weight: 600; color: var(--sub-text); flex-shrink: 0; }
        .row-label.bold-label { font-weight: 800; color: var(--text); font-size: 15px; }

        .time-range-group { display: flex; align-items: center; gap: 12px; flex: 1; }
        .time-box { display: flex; align-items: center; background: var(--input-bg); border: 1px solid transparent; border-radius: 8px; padding: 6px 14px; transition: 0.2s; }
        .time-box:focus-within { background: var(--card); border-color: var(--primary); }
        .time-box span { font-size: 11px; color: var(--sub-text); margin-right: 8px; font-weight: 500; }
        
        input[type="time"], input[type="date"] { border: none; background: transparent; font-size: 15px; color: var(--text); outline: none; font-weight: 500; }
        .range-divider { color: var(--sub-text); font-weight: 400; font-size: 13px; }

        .btn-submit { background: var(--primary); color: white; border: none; padding: 14px; border-radius: 10px; cursor: pointer; font-weight: 600; width: 100%; margin-top: 16px; font-size: 16px; transition: 0.2s; }
        .btn-submit:hover { opacity: 0.8; }

        .table-container { background: var(--card); border-radius: 14px; border: 1px solid var(--border); overflow: hidden; margin-top: 24px; }
        table { width: 100%; border-collapse: collapse; }
        th { background: var(--input-bg); padding: 14px 20px; text-align: left; font-size: 12px; color: var(--sub-text); font-weight: 600; border-bottom: 1px solid var(--border); }
        td { padding: 16px 20px; border-bottom: 1px solid var(--border); font-size: 14px; font-variant-numeric: tabular-nums; }
        .btn-del { color: var(--status-red); cursor: pointer; border: none; background: none; font-size: 13px; font-weight: 500; }
    </style>
</head>
<body>

    <h2 style="text-align: center; margin-bottom: 28px; font-weight: 700; letter-spacing: -0.02em;">ğŸ“… å·¥æ—¶çœ‹æ¿</h2>

    <div class="dashboard">
        <div class="card">
            <h3>æœ¬æœˆç´¯è®¡åŠ ç­ (H)</h3>
            <div style="display: flex; align-items: center; justify-content: center;">
                <input type="number" id="dashTotal" class="dash-input-editable" step="0.1" onchange="manualUpdateTotal()">
                <span id="otStatusBadge" class="status-badge st-red">0.0h</span>
            </div>
            <div class="sub-value">ç›®æ ‡: <input type="number" id="dashGoal" value="30" style="width:30px; border:none; border-bottom:1px solid var(--sub-text); text-align:center; background: transparent; color: var(--text);" onchange="render()"> H</div>
        </div>
        <div class="card">
            <h3>æœ¬æœˆå‰©ä½™éœ€åŠ ç­ (H)</h3>
            <span id="dashRemainingValue" class="dash-value-readonly">0.0</span>
            <div class="sub-value" id="dashRemainingTime">0æ—¶0åˆ†</div>
        </div>
        <div class="card">
            <h3>å‰©ä½™å·¥ä½œæ—¥æ—¥å‡ (H)</h3>
            <span id="dashDailyValue" class="dash-value-readonly" style="color: var(--sub-text);">0.0</span>
            <div class="sub-value" id="dashDaysLeft">å‰©ä½™ 0 å¤© (å«ä»Šæ—¥)</div>
        </div>
    </div>

    <div class="input-panel">
        <div class="form-row">
            <div class="row-label bold-label">è®°å½•æ—¥æœŸ</div>
            <div class="time-box"><input type="date" id="dateInput"></div>
        </div>
        <div class="form-row">
            <div class="row-label">æ­£ç­ (ä¸Šåˆ)</div>
            <div class="time-range-group">
                <div class="time-box"><span>ä¸Šç­</span><input type="time" id="amStart" value="08:30"></div>
                <div class="range-divider">è‡³</div>
                <div class="time-box"><span>ä¸‹ç­</span><input type="time" id="amEnd" value="11:30"></div>
            </div>
        </div>
        <div class="form-row">
            <div class="row-label">æ­£ç­ (ä¸‹åˆ)</div>
            <div class="time-range-group">
                <div class="time-box"><span>ä¸Šç­</span><input type="time" id="pmStart" value="13:00"></div>
                <div class="range-divider">è‡³</div>
                <div class="time-box"><span>ä¸‹ç­</span><input type="time" id="pmEnd" value="17:30"></div>
            </div>
        </div>
        <div class="form-row">
            <div class="row-label" style="color: var(--primary);">åŠ ç­æ‰“å¡</div>
            <div class="time-range-group">
                <div class="time-box"><span>å¼€å§‹</span><input type="time" id="otStart" value="18:30"></div>
                <div class="range-divider">è‡³</div>
                <div class="time-box"><span>ç»“æŸ</span><input type="time" id="otEnd" value="20:00"></div>
            </div>
        </div>
        <button class="btn-submit" onclick="addRecord()">ä¿å­˜ä»Šæ—¥è®°å½•</button>
    </div>

    <div class="table-container">
        <table>
            <thead><tr><th>æ—¥æœŸ</th><th>æ­£å·¥æ—¶ (Max 7.5H)</th><th>åŠ ç­æ—¶é•¿</th><th>æ—¶é—´æ˜ç»†</th><th>æ“ä½œ</th></tr></thead>
            <tbody id="recordTable"></tbody>
        </table>
    </div>

<script>
    const MAX_REGULAR_HOURS = 7.5;
    const OT_VALID_START = "18:30"; 
    const THRESHOLD_CLOSE = 5; 

    let appState = {
        records: JSON.parse(localStorage.getItem('v3_records')) || [],
        manualOffset: parseFloat(localStorage.getItem('v3_offset')) || 0,
        monthlyGoal: parseFloat(localStorage.getItem('v3_goal')) || 30
    };

    document.getElementById('dateInput').valueAsDate = new Date();

    function saveData() {
        localStorage.setItem('v3_records', JSON.stringify(appState.records));
        localStorage.setItem('v3_offset', appState.manualOffset.toString());
        localStorage.setItem('v3_goal', appState.monthlyGoal.toString());
        render();
    }

    function timeToMin(t) { if(!t) return 0; let [h, m] = t.split(':').map(Number); return h * 60 + m; }
    function minToH(m) { return (m / 60).toFixed(1); }
    function minToCN(m) { return `${Math.floor(m/60)}æ—¶${Math.round(m%60)}åˆ†`; }

    function calculateDay(r) {
        let am = Math.max(0, timeToMin(r.amEnd) - timeToMin(r.amStart));
        let pm = Math.max(0, timeToMin(r.pmEnd) - timeToMin(r.pmStart));
        let reg = (am + pm) > 450 ? 450 : (am + pm);
        let otS = timeToMin(r.otStart), otE = timeToMin(r.otEnd);
        if (otE < otS) otE += 1440;
        let vS = timeToMin(OT_VALID_START);
        if (otS < vS && otS > 720) otS = vS;
        return { reg, ot: Math.max(0, otE - otS) };
    }

    function manualUpdateTotal() {
        let currentMonth = new Date().toISOString().slice(0, 7);
        let calcTotalMin = 0;
        appState.records.forEach(r => { if (r.date.startsWith(currentMonth)) calcTotalMin += calculateDay(r).ot; });
        let userVal = parseFloat(document.getElementById('dashTotal').value) || 0;
        appState.manualOffset = userVal - (calcTotalMin / 60);
        saveData();
    }

    function getRemainingWorkdays() {
        let count = 0;
        let today = new Date();
        today.setHours(0, 0, 0, 0); 
        let lastDayOfMonth = new Date(today.getFullYear(), today.getMonth() + 1, 0);
        let current = new Date(today); 
        while (current <= lastDayOfMonth) {
            let dayOfWeek = current.getDay();
            if (dayOfWeek !== 0 && dayOfWeek !== 6) count++;
            current.setDate(current.getDate() + 1);
        }
        return count;
    }

    function addRecord() {
        const date = document.getElementById('dateInput').value;
        if (!date) return;
        appState.records = appState.records.filter(r => r.date !== date);
        appState.records.push({ 
            date, 
            amStart: document.getElementById('amStart').value, amEnd: document.getElementById('amEnd').value,
            pmStart: document.getElementById('pmStart').value, pmEnd: document.getElementById('pmEnd').value,
            otStart: document.getElementById('otStart').value, otEnd: document.getElementById('otEnd').value 
        });
        appState.records.sort((a, b) => new Date(b.date) - new Date(a.date));
        saveData();
    }

    function deleteRecord(d) { appState.records = appState.records.filter(r => r.date !== d); saveData(); }

    function render() {
        const tbody = document.getElementById('recordTable');
        tbody.innerHTML = '';
        let currentMonth = new Date().toISOString().slice(0, 7), calcTotalMin = 0;

        appState.records.forEach(r => {
            let s = calculateDay(r);
            if (r.date.startsWith(currentMonth)) calcTotalMin += s.ot;
            tbody.innerHTML += `<tr><td><strong>${r.date}</strong></td><td>${minToH(s.reg)}H <small style="color:var(--sub-text)">(${minToCN(s.reg)})</small></td><td style="color:var(--primary);font-weight:700">${minToH(s.ot)}H</td><td><small style="color:var(--sub-text)">æ­£:${r.amStart}-${r.amEnd} / ${r.pmStart}-${r.pmEnd} | åŠ :${r.otStart}-${r.otEnd}</small></td><td><button class="btn-del" onclick="deleteRecord('${r.date}')">åˆ é™¤</button></td></tr>`;
        });

        let goal = parseFloat(document.getElementById('dashGoal').value) || 30;
        let finalTotalH = (calcTotalMin / 60) + appState.manualOffset;
        let remainingH = Math.max(0, goal - finalTotalH);
        let days = getRemainingWorkdays();

        document.getElementById('dashTotal').value = finalTotalH.toFixed(1);
        const badge = document.getElementById('otStatusBadge');
        const diff = finalTotalH - goal;
        badge.className = "status-badge " + (finalTotalH >= goal ? "st-green" : (finalTotalH >= goal - THRESHOLD_CLOSE ? "st-yellow" : "st-red"));
        badge.textContent = (diff >= 0 ? "+" : "") + diff.toFixed(1) + "h";

        document.getElementById('dashRemainingValue').textContent = remainingH.toFixed(1);
        document.getElementById('dashRemainingTime').textContent = minToCN(remainingH * 60);
        document.getElementById('dashDailyValue').textContent = days > 0 ? (remainingH / days).toFixed(1) : "0.0";
        document.getElementById('dashDaysLeft').textContent = `å‰©ä½™å·¥ä½œæ—¥: ${days} å¤© (å«ä»Šæ—¥)`;
    }

    render();
</script>
</body>
</html>