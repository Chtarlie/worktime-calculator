<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>工时计算器 V4.1 - 增强版</title>
    <style>
        :root { 
            --primary: #007aff; --bg: #f5f5f7; --card: #ffffff; --text: #1d1d1f; 
            --sub-text: #86868b; --border: #d2d2d7; --input-bg: #f5f5f7;
            --status-red: #ff3b30; --status-yellow: #ff9500; --status-green: #34c759;
        }
        body { font-family: -apple-system, BlinkMacSystemFont, sans-serif; background: var(--bg); color: var(--text); max-width: 900px; margin: 0 auto; padding: 15px; }
        
        /* 核心模块居中与字体增强 */
        .dashboard { display: flex; justify-content: center; gap: 12px; margin-bottom: 20px; flex-wrap: wrap; }
        .card { 
            flex: 1; min-width: 240px; background: var(--card); padding: 25px 18px; 
            border-radius: 14px; text-align: center; border: 1px solid var(--border); 
            box-shadow: 0 2px 8px rgba(0,0,0,0.05); display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        .card h3 { margin: 0 0 15px 0; font-size: 14px; color: var(--sub-text); font-weight: 600; }

        /* 数值样式：放大2号并加粗 */
        .big-value { font-size: 36px; font-weight: 800; line-height: 1.2; }

        /* 环形进度条 */
        .progress-container { position: relative; width: 120px; height: 120px; margin: 10px auto; }
        .progress-svg { transform: rotate(-90deg); width: 120px; height: 120px; }
        .progress-bg { fill: none; stroke: var(--input-bg); stroke-width: 10; }
        .progress-bar { fill: none; stroke-width: 10; stroke-linecap: round; transition: stroke-dasharray 0.5s ease, stroke 0.3s; }
        .progress-text { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; width: 100%; }
        
        /* 输入面板 */
        .input-panel { background: var(--card); padding: 20px; border-radius: 14px; border: 1px solid var(--border); margin-bottom: 20px; }
        .form-row { display: flex; align-items: center; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid var(--border); gap: 10px; }
        .row-label { font-size: 14px; font-weight: 600; width: 85px; flex-shrink: 0; }
        .time-range-group { display: flex; align-items: center; gap: 6px; flex: 1; }
        .time-box { display: flex; align-items: center; background: var(--input-bg); border-radius: 8px; padding: 10px; flex: 1; }
        input { border: none; background: transparent; font-size: 15px; color: var(--text); width: 100%; outline: none; font-weight: 500; }
        
        .btn-check { background: var(--input-bg); border: 1px solid var(--border); border-radius: 8px; padding: 8px 12px; font-size: 13px; cursor: pointer; color: var(--primary); font-weight: 600; transition: 0.2s; }
        .btn-check:active { background: #e5e5ea; transform: scale(0.95); }
        .btn-submit { background: var(--primary); color: white; border: none; padding: 16px; border-radius: 12px; cursor: pointer; font-weight: 700; width: 100%; margin-top: 15px; font-size: 17px; box-shadow: 0 4px 12px rgba(0,122,255,0.3); }

        .table-container { background: var(--card); border-radius: 14px; border: 1px solid var(--border); overflow: hidden; margin-top: 20px; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 14px; font-size: 14px; text-align: left; border-bottom: 1px solid var(--border); }
        .btn-del { color: var(--status-red); border: none; background: none; font-weight: 600; cursor: pointer; }
    </style>
</head>
<body>

    <h2 style="text-align: center; margin: 10px 0 25px 0; font-weight: 800; letter-spacing: -0.5px;">工时助手 V4.1</h2>

    <div class="dashboard">
        <div class="card">
            <h3>累计加班 (H)</h3>
            <input type="number" id="dashTotal" class="big-value" style="color:var(--primary); text-align:center; border:none; background:transparent; width:100%;" step="0.1" onchange="manualUpdateTotal()">
            <div style="font-size:13px; color:var(--sub-text); margin-top:10px;">
                目标: <input type="number" id="dashGoal" value="30" style="width:35px; border-bottom:1px dashed #ccc; font-weight:bold; text-align:center;" onchange="render()"> H
            </div>
        </div>

        <div class="card">
            <h3>剩余需求状态</h3>
            <div class="progress-container">
                <svg class="progress-svg">
                    <circle class="progress-bg" cx="60" cy="60" r="52"></circle>
                    <circle id="progressBar" class="progress-bar" cx="60" cy="60" r="52" stroke-dasharray="326.7" stroke-dashoffset="326.7"></circle>
                </svg>
                <div class="progress-text">
                    <div id="dashRemainingValue" class="big-value">0.0</div>
                    <div style="font-size: 12px; color: var(--sub-text); font-weight: 600;">H</div>
                </div>
            </div>
            <div id="dashRemainingTime" style="font-size:13px; color:var(--sub-text); margin-top:5px; font-weight:500;">0时0分</div>
        </div>

        <div class="card">
            <h3>日均需加班 (H)</h3>
            <div id="dashDailyValue" class="big-value" style="color: var(--sub-text);">0.0</div>
            <div id="dashDaysLeft" style="font-size:13px; color:var(--sub-text); margin-top:15px; font-weight:500;">剩余工作日: 0天</div>
        </div>
    </div>

    <div class="input-panel">
        <div class="form-row">
            <div class="row-label">记录日期</div>
            <div class="time-box"><input type="date" id="dateInput"></div>
            <button class="btn-check" onclick="document.getElementById('dateInput').valueAsDate = new Date()">今天</button>
        </div>
        <div class="form-row">
            <div class="row-label">正班 (上午)</div>
            <div class="time-range-group">
                <div class="time-box"><input type="time" id="amStart" value="08:30"></div>
                <div class="time-box"><input type="time" id="amEnd" value="11:30"></div>
            </div>
            <button class="btn-check" onclick="updateTimeToNow('amEnd')">打卡</button>
        </div>
        <div class="form-row">
            <div class="row-label">正班 (下午)</div>
            <div class="time-range-group">
                <div class="time-box"><input type="time" id="pmStart" value="13:00"></div>
                <div class="time-box"><input type="time" id="pmEnd" value="17:30"></div>
            </div>
            <button class="btn-check" onclick="updateTimeToNow('pmEnd')">打卡</button>
        </div>
        <div class="form-row">
            <div class="row-label" style="color: var(--primary);">加班打卡</div>
            <div class="time-range-group">
                <div class="time-box"><input type="time" id="otStart" value="18:30"></div>
                <div class="time-box"><input type="time" id="otEnd" value="20:00"></div>
            </div>
            <button class="btn-check" onclick="updateTimeToNow('otEnd')">打卡</button>
        </div>
        <button class="btn-submit" onclick="addRecord()">保存今日记录</button>
    </div>

    <div class="table-container">
        <table>
            <thead><tr><th>日期</th><th>时长(H)</th><th>明细</th><th>操作</th></tr></thead>
            <tbody id="recordTable"></tbody>
        </table>
    </div>

    <script>
        let appState = {
            records: JSON.parse(localStorage.getItem('v4_records')) || [],
            manualOffset: parseFloat(localStorage.getItem('v4_offset')) || 0
        };

        // 修复后的打卡功能：获取最新时间并更新
        function updateTimeToNow(targetId) {
            const now = new Date();
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            document.getElementById(targetId).value = `${hours}:${minutes}`;
        }

        function timeToMin(t) { if(!t) return 0; let [h, m] = t.split(':').map(Number); return h * 60 + m; }
        function minToCN(m) { return `${Math.floor(Math.abs(m)/60)}时${Math.round(Math.abs(m)%60)}分`; }

        function calculateDay(r) {
            let otS = timeToMin(r.otStart), otE = timeToMin(r.otEnd);
            if (otE < otS) otE += 1440;
            return { ot: Math.max(0, otE - otS) };
        }

        function getRemainingWorkdays(includeToday) {
            let count = 0, curr = new Date();
            curr.setHours(0,0,0,0);
            if (!includeToday) curr.setDate(curr.getDate() + 1);
            let last = new Date(curr.getFullYear(), curr.getMonth() + 1, 0);
            while (curr <= last) {
                if (curr.getDay() !== 0 && curr.getDay() !== 6) count++;
                curr.setDate(curr.getDate() + 1);
            }
            return count;
        }

        function saveData() {
            localStorage.setItem('v4_records', JSON.stringify(appState.records));
            localStorage.setItem('v4_offset', appState.manualOffset.toString());
            render();
        }

        function addRecord() {
            const date = document.getElementById('dateInput').value;
            if (!date) return;
            appState.records = appState.records.filter(r => r.date !== date);
            appState.records.push({ 
                date, otStart: document.getElementById('otStart').value, otEnd: document.getElementById('otEnd').value 
            });
            saveData();
        }

        function manualUpdateTotal() {
            let currentMonth = new Date().toISOString().slice(0, 7), calcTotalMin = 0;
            appState.records.forEach(r => { if (r.date.startsWith(currentMonth)) calcTotalMin += calculateDay(r).ot; });
            appState.manualOffset = (parseFloat(document.getElementById('dashTotal').value) || 0) - (calcTotalMin/60);
            saveData();
        }

        function render() {
            const tbody = document.getElementById('recordTable');
            tbody.innerHTML = '';
            let todayStr = new Date().toISOString().slice(0, 10);
            let currentMonth = todayStr.slice(0, 7);
            let calcTotalMin = 0, isTodayRecorded = false;

            appState.records.sort((a,b) => new Date(b.date) - new Date(a.date)).forEach(r => {
                let s = calculateDay(r);
                if (r.date.startsWith(currentMonth)) calcTotalMin += s.ot;
                if (r.date === todayStr) isTodayRecorded = true;
                tbody.innerHTML += `<tr><td>${r.date.slice(5)}</td><td>${(s.ot/60).toFixed(1)}</td><td><small>${r.otStart}-${r.otEnd}</small></td><td><button class="btn-del" onclick="appState.records=appState.records.filter(x=>x.date!=='${r.date}');saveData()">删除</button></td></tr>`;
            });

            let goal = parseFloat(document.getElementById('dashGoal').value) || 30;
            let finalH = (calcTotalMin/60) + appState.manualOffset;
            
            // 核心规则：剩余需求数值逻辑
            // 未达标：finalH < goal -> 结果为负数
            // 已达标：finalH >= goal -> 结果为0或正数
            let remainH = finalH - goal; 
            
            let days = getRemainingWorkdays(!isTodayRecorded);

            // 更新环形进度条 (周长约为 326.7)
            const circle = document.getElementById('progressBar');
            const percent = Math.min(100, (finalH / goal) * 100);
            const offset = 326.7 - (326.7 * percent / 100);
            circle.style.strokeDashoffset = offset;
            
            // 颜色逻辑
            let statusColor = varName = '--status-red';
            if (finalH >= goal) statusColor = '--status-green';
            else if (finalH >= goal - 5) statusColor = '--status-yellow';
            circle.style.stroke = `var(${statusColor})`;

            document.getElementById('dashTotal').value = finalH.toFixed(1);
            
            // 剩余需求数值显示
            const remainEl = document.getElementById('dashRemainingValue');
            remainEl.textContent = remainH.toFixed(1);
            remainEl.style.color = `var(${statusColor})`;
            
            document.getElementById('dashRemainingTime').textContent = (remainH < 0 ? "还差 " : "超出 ") + minToCN(remainH * 60);
            
            // 日均计算逻辑 (基于绝对值缺口)
            let gapH = Math.max(0, goal - finalH);
            document.getElementById('dashDailyValue').textContent = days > 0 ? (gapH/days).toFixed(1) : "0.0";
            document.getElementById('dashDaysLeft').textContent = `剩余工作日: ${days}天(${isTodayRecorded?'不含今日':'含今日'})`;
        }

        document.getElementById('dateInput').valueAsDate = new Date();
        render();
    </script>
</body>
</html>
