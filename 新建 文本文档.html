<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å·¥æ—¶è®¡ç®—å™¨ V3.6 - å…¨è®¾å¤‡é€‚é…ç‰ˆ</title>
    <style>
        :root { 
            --primary: #007aff; --bg: #f5f5f7; --card: #ffffff; --text: #1d1d1f; 
            --sub-text: #86868b; --border: #d2d2d7; --input-bg: #f5f5f7;
            --status-red: #ff3b30; --status-yellow: #ff9500; --status-green: #34c759;
        }

        @media (prefers-color-scheme: dark) {
            :root {
                --bg: #000000; --card: #1c1c1e; --text: #f5f5f7; --sub-text: #a1a1a6;
                --border: #38383a; --input-bg: #2c2c2e;
            }
        }

        body { 
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "PingFang SC", sans-serif;
            background: var(--bg); color: var(--text); max-width: 900px; margin: 0 auto; padding: 15px; 
            line-height: 1.4; -webkit-font-smoothing: antialiased;
        }

        /* ä»ªè¡¨ç›˜è‡ªé€‚åº” */
        .dashboard { display: grid; grid-template-columns: repeat(auto-fit, minmax(100%, 1fr)); gap: 12px; margin-bottom: 20px; }
        @media (min-width: 600px) { .dashboard { grid-template-columns: repeat(3, 1fr); } }

        .card { background: var(--card); padding: 18px; border-radius: 14px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); text-align: center; border: 1px solid var(--border); }
        .card h3 { margin: 0 0 8px 0; font-size: 12px; color: var(--sub-text); font-weight: 600; }
        .dash-value-readonly, .dash-input-editable { font-size: 28px; font-weight: 700; color: var(--primary); font-variant-numeric: tabular-nums; }
        .dash-input-editable { border: none; border-bottom: 2px dashed var(--border); width: 80px; text-align: center; background: transparent; color: var(--text); }

        /* è¾“å…¥é¢æ¿é€‚é… */
        .input-panel { background: var(--card); padding: 16px; border-radius: 14px; border: 1px solid var(--border); margin-bottom: 20px; }
        
        .form-row { display: flex; flex-direction: column; padding: 12px 0; border-bottom: 1px solid var(--border); }
        @media (min-width: 600px) { .form-row { flex-direction: row; align-items: center; } }

        .row-label { font-size: 14px; font-weight: 600; margin-bottom: 8px; width: 100%; }
        @media (min-width: 600px) { .row-label { width: 110px; margin-bottom: 0; } }

        .time-range-group { display: flex; align-items: center; gap: 8px; width: 100%; justify-content: space-between; }
        
        .time-box { 
            display: flex; align-items: center; background: var(--input-bg); border-radius: 8px; 
            padding: 8px 10px; flex: 1; min-width: 0; /* é˜²æ­¢æº¢å‡º */
        }
        .time-box span { font-size: 10px; color: var(--sub-text); margin-right: 4px; white-space: nowrap; }
        
        input[type="time"], input[type="date"] { 
            border: none; background: transparent; font-size: 15px; color: var(--text); 
            outline: none; width: 100%; -webkit-appearance: none; /* ç§»é™¤iOSé»˜è®¤æ ·å¼ */
        }

        .btn-submit { 
            background: var(--primary); color: white; border: none; padding: 15px; 
            border-radius: 12px; cursor: pointer; font-weight: 600; width: 100%; 
            margin-top: 15px; font-size: 16px;
        }

        /* è¡¨æ ¼æ»šåŠ¨é€‚é… */
        .table-container { background: var(--card); border-radius: 14px; border: 1px solid var(--border); overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; min-width: 500px; } /* ç§»åŠ¨ç«¯ä¿è¯æœ€å°å®½åº¦ï¼Œæ”¯æŒæ¨ªæ»‘ */
        th, td { padding: 12px 10px; font-size: 13px; text-align: left; border-bottom: 1px solid var(--border); }
        .btn-del { color: var(--status-red); font-size: 12px; font-weight: 600; background: none; border: none; }
    </style>
</head>
<body>

    <h2 style="text-align: center; margin: 10px 0 20px 0; font-size: 20px;">ğŸ“… å·¥æ—¶çœ‹æ¿</h2>

    <div class="dashboard">
        <div class="card">
            <h3>ç´¯è®¡åŠ ç­ (H)</h3>
            <input type="number" id="dashTotal" class="dash-input-editable" step="0.1" onchange="manualUpdateTotal()">
            <span id="otStatusBadge" class="status-badge st-red" style="display:block; margin-top:5px; width:fit-content; margin-inline:auto;">0.0h</span>
            <div class="sub-value">ç›®æ ‡: <input type="number" id="dashGoal" value="30" style="width:30px; border:none; background:transparent; color:var(--text); text-align:center;" onchange="render()"> H</div>
        </div>
        <div class="card">
            <h3>å‰©ä½™éœ€åŠ ç­ (H)</h3>
            <span id="dashRemainingValue" class="dash-value-readonly">0.0</span>
            <div class="sub-value" id="dashRemainingTime">0æ—¶0åˆ†</div>
        </div>
        <div class="card">
            <h3>æ—¥å‡éœ€åŠ ç­ (H)</h3>
            <span id="dashDailyValue" class="dash-value-readonly" style="color: var(--sub-text);">0.0</span>
            <div class="sub-value" id="dashDaysLeft">å‰©ä½™ 0 å¤© (å«ä»Šæ—¥)</div>
        </div>
    </div>

    <div class="input-panel">
        <div class="form-row">
            <div class="row-label" style="font-weight: 800;">è®°å½•æ—¥æœŸ</div>
            <div class="time-box"><input type="date" id="dateInput"></div>
        </div>
        <div class="form-row">
            <div class="row-label">æ­£ç­ (ä¸Šåˆ)</div>
            <div class="time-range-group">
                <div class="time-box"><span>ä¸Šç­</span><input type="time" id="amStart" value="08:30"></div>
                <div class="range-divider">è‡³</div>
                <div class="time-box"><span>ä¸‹ç­</span><input type="time" id="amEnd" value="11:30"></div>
            </div>
        </div>
        <div class="form-row">
            <div class="row-label">æ­£ç­ (ä¸‹åˆ)</div>
            <div class="time-range-group">
                <div class="time-box"><span>ä¸Šç­</span><input type="time" id="pmStart" value="13:00"></div>
                <div class="range-divider">è‡³</div>
                <div class="time-box"><span>ä¸‹ç­</span><input type="time" id="pmEnd" value="17:30"></div>
            </div>
        </div>
        <div class="form-row">
            <div class="row-label" style="color: var(--primary);">åŠ ç­æ‰“å¡</div>
            <div class="time-range-group">
                <div class="time-box"><span>å¼€å§‹</span><input type="time" id="otStart" value="18:30"></div>
                <div class="range-divider">è‡³</div>
                <div class="time-box"><span>ç»“æŸ</span><input type="time" id="otEnd" value="20:00"></div>
            </div>
        </div>
        <button class="btn-submit" onclick="addRecord()">ä¿å­˜ä»Šæ—¥è®°å½•</button>
    </div>

    <div class="table-container">
        <table>
            <thead><tr><th>æ—¥æœŸ</th><th>æ­£ç­</th><th>åŠ ç­</th><th>æ˜ç»†</th><th>æ“ä½œ</th></tr></thead>
            <tbody id="recordTable"></tbody>
        </table>
    </div>

<script>
    // JS é€»è¾‘ä¿æŒ V3.5 æ ¸å¿ƒä¸å˜ï¼ˆå«ä»Šæ—¥å·¥ä½œæ—¥è®¡ç®—ï¼‰
    let appState = {
        records: JSON.parse(localStorage.getItem('v3_records')) || [],
        manualOffset: parseFloat(localStorage.getItem('v3_offset')) || 0,
        monthlyGoal: parseFloat(localStorage.getItem('v3_goal')) || 30
    };

    function saveData() {
        localStorage.setItem('v3_records', JSON.stringify(appState.records));
        localStorage.setItem('v3_offset', appState.manualOffset.toString());
        localStorage.setItem('v3_goal', appState.monthlyGoal.toString());
        render();
    }

    function timeToMin(t) { if(!t) return 0; let [h, m] = t.split(':').map(Number); return h * 60 + m; }
    function minToH(m) { return (m / 60).toFixed(1); }
    function minToCN(m) { return `${Math.floor(m/60)}æ—¶${Math.round(m%60)}åˆ†`; }

    function calculateDay(r) {
        let am = Math.max(0, timeToMin(r.amEnd) - timeToMin(r.amStart));
        let pm = Math.max(0, timeToMin(r.pmEnd) - timeToMin(r.pmStart));
        let reg = (am + pm) > 450 ? 450 : (am + pm);
        let otS = timeToMin(r.otStart), otE = timeToMin(r.otEnd);
        if (otE < otS) otE += 1440;
        let vS = timeToMin("18:30");
        if (otS < vS && otS > 720) otS = vS;
        return { reg, ot: Math.max(0, otE - otS) };
    }

    function getRemainingWorkdays() {
        let count = 0, today = new Date();
        today.setHours(0,0,0,0);
        let last = new Date(today.getFullYear(), today.getMonth() + 1, 0);
        let curr = new Date(today);
        while (curr <= last) {
            if (curr.getDay() !== 0 && curr.getDay() !== 6) count++;
            curr.setDate(curr.getDate() + 1);
        }
        return count;
    }

    function addRecord() {
        const date = document.getElementById('dateInput').value;
        if (!date) return;
        appState.records = appState.records.filter(r => r.date !== date);
        appState.records.push({ 
            date, amStart: document.getElementById('amStart').value, amEnd: document.getElementById('amEnd').value,
            pmStart: document.getElementById('pmStart').value, pmEnd: document.getElementById('pmEnd').value,
            otStart: document.getElementById('otStart').value, otEnd: document.getElementById('otEnd').value 
        });
        appState.records.sort((a,b) => new Date(b.date) - new Date(a.date));
        saveData();
    }

    function manualUpdateTotal() {
        let currentMonth = new Date().toISOString().slice(0, 7), calcTotalMin = 0;
        appState.records.forEach(r => { if (r.date.startsWith(currentMonth)) calcTotalMin += calculateDay(r).ot; });
        appState.manualOffset = (parseFloat(document.getElementById('dashTotal').value) || 0) - (calcTotalMin/60);
        saveData();
    }

    function render() {
        const tbody = document.getElementById('recordTable');
        tbody.innerHTML = '';
        let currentMonth = new Date().toISOString().slice(0, 7), calcTotalMin = 0;
        appState.records.forEach(r => {
            let s = calculateDay(r);
            if (r.date.startsWith(currentMonth)) calcTotalMin += s.ot;
            tbody.innerHTML += `<tr><td>${r.date.slice(5)}</td><td>${minToH(s.reg)}H</td><td style="color:var(--primary);font-weight:700">${minToH(s.ot)}H</td><td><small>${r.otStart}-${r.otEnd}</small></td><td><button class="btn-del" onclick="appState.records=appState.records.filter(x=>x.date!=='${r.date}');saveData()">åˆ é™¤</button></td></tr>`;
        });
        let goal = parseFloat(document.getElementById('dashGoal').value) || 30;
        let finalH = (calcTotalMin/60) + appState.manualOffset;
        let remainH = Math.max(0, goal - finalH);
        let days = getRemainingWorkdays();
        document.getElementById('dashTotal').value = finalH.toFixed(1);
        document.getElementById('dashRemainingValue').textContent = remainH.toFixed(1);
        document.getElementById('dashRemainingTime').textContent = minToCN(remainH * 60);
        document.getElementById('dashDailyValue').textContent = days > 0 ? (remainH/days).toFixed(1) : "0.0";
        document.getElementById('dashDaysLeft').textContent = `å‰©ä½™å·¥ä½œæ—¥: ${days} å¤© (å«ä»Šæ—¥)`;
        const diff = finalH - goal;
        const badge = document.getElementById('otStatusBadge');
        badge.textContent = (diff >= 0 ? "+" : "") + diff.toFixed(1) + "h";
        badge.className = "status-badge " + (finalH >= goal ? "st-green" : (finalH >= goal-5 ? "st-yellow" : "st-red"));
    }

    document.getElementById('dateInput').valueAsDate = new Date();
    render();
</script>
</body>
</html>